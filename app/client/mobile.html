<!doctype html>
<html manifest="do-me.manifest" ng-app="do-me">

  <head>
    <title>Do Me</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <!--  <meta name="viewport" content="user-scalable=no, width=device-width,   initial-scale=1.0, maximum-scale=1.0"/> -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <!-- <link rel="apple-touch-startup-image" href="startup.png" /> -->
    
    <link rel="stylesheet" href="libs/jquery.mobile/jquery.mobile-1.3.1.min.css" />
    <!-- <link rel="stylesheet" type="text/css" href="css/main.css"> -->
    
    <script src="libs/jquery-1.8.3.min.js"></script>
    <script src="libs/angular.min.js"></script>
    <script src="libs/jquery.mobile/jquery.mobile-1.3.1.min.js"></script>
    <script src="libs/jquery-mobile-angular-adapter.min.js"></script>
    <script src="libs/keymaster.min.js"></script>
    <script src="libs/sprintf-0.5.js"></script>
    <script src="libs/humanized_time_span.js"></script>
    <link rel="stylesheet" type="text/css" href="libs/message/themes/message_default.css">
    <script src="libs/message/message.js"></script>
    <script src="libs/backup-0.1.js"></script>

    <script type="text/javascript">
      window.do_me = {mobile: true};

      // Check if a new cache is available on page load.
      // TODO Move this to a background poller to speed up page load and detect
      // new version in long-running instances.
      window.addEventListener('load', function(e) {
        window.applicationCache.addEventListener('updateready', function(e) {
          if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
            // Browser downloaded a new app cache.
            // Swap it in and reload the page to get the new hotness.
            window.applicationCache.swapCache();
            if (confirm("A new version of this site is available. Load it?")) {
              window.location.reload();
            } else {
              alert("Things may not work properly until you reload the page.");
            }
          }
        }, false);
      }, false);

      angular.module('do-me', []); // define the do-me module
    </script>
    <script src="storage.js"></script>
    <script src="net.js"></script>
    <script src="search.js"></script>
    <script src="sync.js"></script>
    <script src="tasks.js"></script>
    <script src="message_ctrl.js"></script>
    <script src="search_ctrl.js"></script>
    <script src="sync_ctrl.js"></script>
    <script src="tags_ctrl.js"></script>
    <script src="tasks_ctrl.js"></script>
  </head>
  
  <body ng-controller="SearchCtrl">

    <div ng-controller="MessageCtrl"></div> <!-- Just a place holder to load controller. Nothing shown here. -->

    <div ng-controller="SyncCtrl"></div> <!-- Just a place holder to load controller. Nothing shown here. -->

    <div data-role="page" id="tags" ngm-shared-controller="tagsCtrl:TagsCtrl">
    
      <div data-role="header">
        <a href="#help" data-role="button" data-icon="info">Help</a>
        <h1>Tags (Lists)</h1>
        <a href="#edit-tags" data-role="button" class="ui-btn-right">
          Edit Tags
        </a>      
      </div><!-- /header -->
    
      <div data-role="content">
        <ul data-role="listview" data-inset="true">
          <li>
            <a href="#show-tasks" ng-click="tagsCtrl.searchFor('')">All Not Waiting</a>
          </li>
          <li ng-show="tagsCtrl.presentTags().length == 0">
            You don't have any lists. Click edit lists above to add some.
          </li>
          <li ng-repeat="tag in tagsCtrl.presentTags() | orderBy:'text'">
            <a href="#show-tasks" ng-click="tagsCtrl.searchFor(tag.text)">{{tag.text}}</a>
          </li>
          <li>
            <a href="#show-tasks" ng-click="tagsCtrl.searchFor('waiting:only')">Waiting</a>
          </li>
          <li data-role="fieldcontain">
            <form ng-submit="tagsCtrl.searchHandler($event, searchTemp)">
              <input type="text" placeholder="Search for text or tag" ng-model="searchTemp">
            </form>
          </li>
        </ul>
      </div><!-- /content -->
    
    </div><!-- /tags page -->
    
    <div data-role="page" id="edit-tags" ngm-shared-controller="tagsCtrl:TagsCtrl">
    
      <div data-role="header">
        <a href="#" data-role="button" data-icon="back" data-rel="back">Back</a>
        <h1>Edit Tags</h1>
      </div><!-- /header -->
    
      <div data-role="content">
        <ul data-role="listview" data-inset="true">
          <li data-role="fieldcontain">
            <form ng-submit="tagsCtrl.addTag()" data-ajax="false">
              <input placeholder="Add saved tag" ng-model="tagsCtrl.newTag">
              <!-- type="email" would make @ and # more quickly accessible on ios but breaks ng-model binding -->
            </form>
          </li>
        </ul>

        <ul>
          Deleting a tag will only delete it from the list of tags; it <b>won't delete any tasks</b> even if they use that tag.
        </ul>
        
        <ul data-role="listview" data-inset="true">
          <li ng-repeat="tag in tagsCtrl.presentTags() | orderBy:'text'" data-icon="delete">
            <a href="" ng-click="tagsCtrl.deleteTag(tag)">{{tag.text}}</a>
          </li>
<!--      TODO save and cancel buttons instead of back
          <li class="ui-body ui-body-b">
            <fieldset class="ui-grid-a">
                <div class="ui-block-a"><button type="submit" data-theme="d">Cancel</button></div>
                <div class="ui-block-b"><button type="submit" data-theme="a">Save</button></div>
              </fieldset>
          </li>
 -->
        </ul>
      </div><!-- /content -->
    
    </div><!-- /edit-tags page -->
        
    <div data-role="page" id="show-tasks">
    
      <div data-role="header" ng-controller="SearchCtrl">
        <a href="#" data-role="button" data-icon="back" data-rel="back">Back</a>
        <h1 ng-show="searchInput == ''">All Not Waiting</h1>
        <h1 ng-show="searchInput != ''">{{searchInput}}</h1>
        <a href="#add-task" data-role="button" data-icon="plus">
          Add Task
        </a>
      </div><!-- /header -->
    
      <div data-role="content" ngm-shared-controller="taskCtrl:TasksCtrl">
        <ul data-role="listview">
          <li ng-show="taskCtrl.getResults().length == 0">Nothing to do!</li>

          <li ng-repeat="task in taskCtrl.getResults()">
            <!-- <div class="ui-grid-a">
              <!-- <div class="ui-block-a" style="width: 80%"> -->
              <a href="#edit-task" ng-click="taskCtrl.editTask($index)">
                <h3 ng-bind-html-unsafe="taskCtrl.linkify(task.text)" style="white-space:normal;"></h3>
                <p><strong ng-repeat="tag in task.tags">{{tag}} </strong></p>
              </a>
              <!-- </div> -->
              <!-- <div class="ui-block-b" style="width: 20%"> -->
<!--                 <form action="#edit-task" method="get">
                  <button type="submit" data-icon="arrow-r">&nbsp;</button>
                </form>
 -->
         <!-- <a href="#edit-task" data-role="button" data-icon="delete" data-theme="b">&nbsp;</a> -->
              <!-- </div> -->
            <!-- </div> -->
          </li>
        </ul>
      </div><!-- /content -->
    
    </div><!-- /tasks page -->
    
    
    <div data-role="page" id="add-task" ngm-shared-controller="taskCtrl:TasksCtrl tagsCtrl:TagsCtrl">
    
      <div data-role="header">
        <a href="#" data-role="button" data-icon="back" data-rel="back">Back</a>
        <h1>Add Task</h1>
      </div><!-- /header -->
    
      <div data-role="content" >
        <form ng-submit="taskCtrl.addTask()" data-ajax="false">
          <textarea placeholder='Eg, "#FixApt @Home Hang shelves"' ng-model="taskCtrl.newTask" class="submit-on-enter"></textarea>
          Project:
          <select ng-model="taskCtrl.selectedProject">
            <option value=""></option>
            <option ng-repeat="tag in tagsCtrl.projects() | orderBy:'text'" value="{{tag.text}}">{{tag.text}}</option>
          </select>
          Context:
          <select ng-model="taskCtrl.selectedContext">
            <option value=""></option>
            <option ng-repeat="tag in tagsCtrl.contexts() | orderBy:'text'" value="{{tag.text}}">{{tag.text}}</option>
          </select>
        <br>
        <a href="#" ng-click="taskCtrl.addTask()" data-role="button" data-icon="save" style="background: blue; color: white;">
          Save
        </a>
        </form>
      </div><!-- /content -->
    
    </div><!-- /edit page -->
    
    
    <div data-role="page" id="edit-task" ngm-shared-controller="taskCtrl:TasksCtrl">
    
      <div data-role="header">
        <a href="#" data-role="button" data-icon="back" data-rel="back">Back</a>
        <!-- <a href="#main" data-icon="delete">Cancel</a> -->
        <h1>Edit Task</h1>
        <!-- <a href="#main" id="save" data-icon="check" data-theme="b">Save</a> -->
      </div><!-- /header -->
    
      <div data-role="content" >
        <form ng-submit="taskCtrl.updateTask()" data-ajax="false">
          <textarea placeholder='Eg, "#FixApt @Home Hang shelves"' ng-model="taskCtrl.editing.text" class="submit-on-enter"></textarea>
        </form>
        <div>&nbsp;</div>
        <a href="#" ng-click="taskCtrl.finishTask()" data-role="button" data-icon="check" style="background: green; color: white;">
          Task Done
        </a>
        <br>
        <a href="#" ng-click="taskCtrl.addTask()" data-role="button" data-icon="save" style="background: blue; color: white;">
          Save
        </a>
      </div><!-- /content -->
    
    </div><!-- /edit page -->
    
    
    <div data-role="page" id="help">

      <div data-role="header">
        <a href="#" data-role="button" data-icon="back" data-rel="back">Back</a>
        <h1>Help</h1>
      </div><!-- /header -->
    
      <p>I love feedback! Please email it to
      <a href="mailto:daniel@benamy.info">daniel@benamy.info</a>.</p>
      
    </div><!-- /help page -->

    <script type="text/javascript">
      $('.submit-on-enter').keydown(function(event) {
        if (event.keyCode === 13) {
          $(this).submit();
          return false;
        };
      })
    </script>
  </body>
</html>
